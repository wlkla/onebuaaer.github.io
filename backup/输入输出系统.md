# 第七章：输入/输出系统

## I/O​系统基本概念

### 输入/输出系统

1. 外部设备：包括输入/输出设备以及通过输入/输出接口才能访问的外存储设备
2. 接口：在各个外设与主机之间传输数据时进行各种协调工作的逻辑部件
3. 输入设备：用于向计算机系统输入命令和文本、数据等信息的部件
4. 输出设备：用于将计算机系统中的信息输出到计算机外部进行显示、交换等的部件
5. 外存设备：除计算机内存及CPU缓存外的存储器
6. I/O软件：包括驱动程序、用户程序、管理程序、升级补丁等
7. I/O硬件：包括外部设备、设备控制器和接口、I/O总线等

### I/O控制方式

1. 程序查询方式：由CPU通过程序不断查询I/O设备是否已经做好准备，从而控制I/O设备与主机交换信息
2. 程序中断方式：只在I/O设备准备就绪并向CPU发出中断请求时才予以响应
3. DMA方式：主存和I/O设备之间有一条直接数据通路，当主存和I/O设备交换信息时，无需调用中断服务程序
4. 通道方式：在系统中设有通道控制部件，每个通道都挂接若干外设，主机在执行I/O命令时，只需要启动有关通道，通道将执行通道程序，从而完成I/O操作

## I/O​接口

### I/O​接口的功能

1. 进行地址译码和设备选择
   - CPU送来选择外设的地址码后，接口必须对地址进行译码以产生设备选择信息，使主机能和指定外设交换信息
2. 实现主机和外设的通信联络控制
   - 解决主机和外设时序配合问题，协调不同工作速度的外设和主机之间交换信息，以保证整个计算机系统能统一、协调工作
3. 实现数据缓冲
   - CPU与外设之间的速度往往不匹配，为消除速度差异，接口必须设置数据缓冲寄存器，用于数据的暂存，以避免因速度不一致而丢失数据
4. 信号格式的转换
   - 外设与主机两者的电平、数据格式都可能存在差异，接口应提供主机与外设之间的信号格式转换功能
5. 传送控制命令和状态信息
   - CPU要启动某外设时，通过接口中的命令寄存器向外设发出启动命令；外设准备就绪时，则需要发聩给CPU相应的信号。外设向CPU提出中断请求时，CPU也应有相应的响应信号反馈给外设

### I/O​接口的基本结构

1. 数据缓冲寄存器：用来暂存与CPU或内存之间传送的数据信息

2. 状态寄存器：用来记录接口和设备的状态信息

3. 控制寄存器用来保存CPU对外设的控制信息

   > 注：因为状态寄存器和控制寄存器在传送方向上是相反的，在访问时间上是错开的，因此可合并

4. 数据线：传送读/写数据、状态信息、控制信息和中断类型号

5. 地址线：传送要访问的I/O接口中的寄存器的地址

6. 控制线：传送读/写控制信号、中断请求和响应信号、仲裁信号和握手信号

7. I/O控制逻辑：对控制寄存器中的命令字进行译码，将译码结果通过外设界面控制逻辑送至外设，同时还要将数据缓冲寄存器中的数据发送到外设或从外设接受数据到数据缓冲寄存器；收集外设状态到状态寄存器

   > 对数据缓冲寄存器、状态/控制寄存器的访问操作是通过相应的指令来完成的，通常称这类指令为I/O指令

### I/O​接口的类型

1. 按数据传送方式：
   - 并行接口
   - 串行接口
2. 按主机访问I/O设备的控制方式：
   - 程序查询接口
   - 中断接口
   - DMA接口
3. 按功能选择的灵活性：
   - 可编程接口
   - 不可编程接口

### I/O​端口及其编址

1. 独立编址/I/O映射方式
   - 对所有I/O端口单独进行编址。需要设置专门的I/O指令来表明访问的是I/O​地址空间。
   - 优点：端口数比主存单元数少，只需要少量地址线，使得I/O端口译码简单，寻址速度更快。使用专有指令，使程序更加清晰
   - 缺点：I/O指令少，只提供简单的传输操作，所以程序设计的灵活性较差。CPU需要提供存储器读/写、I/O读/写两组控制信号，增大了控制的复杂性。
2. 统一编址/存储器映射方式
   - 把主存地址空间分出一部分给I/O端口进行编址。无须设置专门的I/O指令，用统一的访存指令就可以访问I/O​端口
   - 优点：不需要专门的I/O指令，使得CPU访问I/O的操作更加灵活方便。端口有较大的编制空间。
   - 缺点：端口地址专用了主存地址空间，使主存可用容量变小。由于在识别端口时全部地址线都要参与译码，导致译码速度降低。

### 错题

1. 下列功能中，属于I/O接口的功能的是(  )

   I. 数据格式的转换

   II. I/O过程中错误与状态检测

   III. I/O操作的控制与定时

   IV. 与主机和外设通信

   A. I和IV

   B. I、III和IV

   C. I、II和IV

   D. I、II、III和IV

2. 下列关于I/O指令的说法中，错误的是(  )

   A. I/O指令是CPU系统指令的一部分

   B. I/O指令是机器指令的一类

   C. I/O指令反映CPU和I/O设备交换信息的特点

   D. I/O指令的格式和通用指令的格式相同

3. 采用中断方式进行打印控制时，在打印控制接口和打印机之间交换的信息不包括(  )

   A. 打印字符点阵信息

   B. 打印控制信息

   C. 打印机状态信息

   D. 中断请求信号

4. 主机和外设之间的直接连接通路是(  )

   A. CPU和主存 — I/O总线 — 通信总线 — I/O接口 — 外设

   B. CPU和主存 — I/O总线 — I/O接口 — 通信总线 — 外设

   C. CPU和主存 — I/O接口 — I/O总线 — 通信总线 — 外设

   D. CPU和主存 — I/O接口 — 通信总线 — I/O总线 — 外设

## I/O方式

### 程序查询方式

1. 信息交换的控制直接由CPU执行程序实现。程序查询方式接口中设置一个数据缓冲寄存器和一个设备状态寄存器。主机进行I/O​操作时，先读取设备的状态并根据设备状态决定下一步操作。

2. 根据CPU查询外设是否准备就绪的方式，程序查询方式又分为以下两种：

   - `独占方式`：CPU花费100%时间用于I/O操作，此时外设和CPU完全串行工作。

   - `定时查询`：CPU​周期性查询接口状态，每次等到条件满足才进行一个数据的传输，传送完毕后返回到用户程序。

### 程序中断方式

1. CPU在程序中安排好在某个时机启动某台外设，然后CPU继续执行当前程序。一旦外设完成数据传送的准备工作，就主动向CPU发出中断请求。在可以响应中断的条件下，CPU终止当前程序，执行中断服务程序，数据传送完成后，CPU返回原来程序。

2. 工作流程为：
   
   - 中断请求
   
     - 为记录中断事件并区分不同的中断源，中断系统需要对每个中断源设置中断请求标记触发器，当其状态为“1”时，表示该中断源有请求。
   
   - 中断响应判优
   
     - 定义：CPU​响应请求的先后顺序
   
     - 一般来说：
       不可屏蔽中断 > 内部异常 > ​可屏蔽中断
       硬件故障 > 软件中断
   
       DMA中断请求 >  I/O设备的中断请求
   
       高速设备 > 低速设备
   
       输入设备 > 输出设备
   
       实时设备 > 普通设备
   
   - CPU响应中断的条件
     - 中断源有中断请求
     - CPU允许中断即开中断
     - 一条指令执行完毕，且没有更紧迫的任务
   
   - 中断响应条件
     - CPU响应中断后，经过中断隐指令，转去执行中断服务程序。中断隐指令本质上是硬件的一系列自动操作，不是一条真正的指令。
     - 中断隐指令包括以下操作：
       `关中断`：CPU响应中断后，需要保护程序的断点和现场信息，在此过程中，CPU不能响应更高级中断源的中断请求。
     - `保存断点`：将源程序的断点保存到栈或特定寄存器中。
     - `引出中断服务程序`：识别中断源，将对应的服务程序入口地址送入程序计数器PC
   
   - 中断向量
   
     - 中断识别分为向量中断和非向量中断
   
     - 每个中断源都有一个唯一的类型号，每个中断类型号都对应一个中断服务程序，每个中断服务程序都有一个入口地址，即`中断向量`。
   
     - 向量中断：CPU响应中断后，通过识别中断源获得中断类型号，然后据此计算出对应中断向量的地址；根据地址取出中断服务程序的入口地址，并送入程序计数器PC，以转去执行中断服务程序。
   
   - 中断处理过程
   
     - 中断处理流程为：
       (1). 关中断
       (2). 保存断点
   
       (3). 中断服务程序寻址
   
       (4). 保存现场和屏蔽字
   
       (5). 开中断 （在单中断种无）
   
       (6). 执行中断服务程序
   
       (7). 关中断 （在单中断种无）
   
       (8). 恢复现场和屏蔽字
   
       (9). 开中断、中断返回
   
3. 多重中断和中断屏蔽技术
   - 单重中断：在CPU执行中断服务程序的过程中，若有出现新的优先级更高的中断程序，而CPU对心得中断请求不予响应。
   - 多重中断/中断嵌套：CPU暂停现行的中断服务程序，转去处理新的中断请求。
   - CPU要具备多重中断的功能，必须满足以下条件：
     (1). 在中断服务程序中提前设置开中断指令
     (2). 优先级高的中断源有权中断优先级低的中断源
   - 每个中断源都有一个`屏蔽触发器`，1表示屏蔽该中断源的请求，0表示可以正常请求，所有屏蔽触发器组合在一起便构成`屏蔽字寄存器`，屏蔽字寄存器的内容称为`屏蔽字`。

### DMA方式

1. DMA方式完全由硬件进行成组信息传送，具有程序中断的优点：在数据准备阶段，CPU与外设并行工作。

2. DMA方式的特点：
   主存和DMA接口之间有一条直接数据通路，传送数据不必中断现行程序，I/O与主机并行工作，程序和传送并行工作。

   - 主存既可以被CPU访问，又可以被外设访问
   - 数据传送时，主存地址的确定、传送数据的计数都由硬件电路直接实现
   - 主存中要开辟专用缓存区，以即使提供和接受外设的数据
   - DMA传送速度快，CPU和外设并行工作，提高了系统效率
   - DMA在传送开始前要通过程序进行预处理，结束后要通过中断方式进行后处理

3. DMA控制器的组成

   - DMA​控制器：对数据传送过程进行控制的硬件

   - 当I/O设备要进行数据传输时，通过DMA控制器向CPU提出DMA传送请求，CPU响应后让出系统总线，由DMA控制器接管总线进行数据传送

   - 主要功能：
     (1). 接受外设发出的DMA请求，并向CPU发出总线请求

     (2). CPU响应并发出总线响应信号，DMA接管总线控制权，进入DMA操作周期

     (3). 确定传送数据的主存起始地址及长度，并自动修改主存地址计数和传送长度计数

     (4). 规定数据在主存和外设之间的传送方向，发出读/写等控制信号，执行数据传送操作

     (5). 向CPU报告DMA操作结束

   - 主存地址计数器：存放要交换数据的主存地址（自动`+1`）。

   - 传送长度计数器：记录传送数据的总长度（自动`-1`）。

   - 数据缓冲寄存器：暂存每次传送的数据。

   - DMA请求触发器：每当I/O设备准备好数据后，发出一个控制信号，使DMA请求触发器置位。

   - 控制/状态逻辑：用于指定传送方向，修改传送参数，并对DMA请求信号、CPU响应信号进行协调和同步。

   - 中断机构：当一批数据传送完毕后出发中断机构，向CPU提出中断请求。

4. DMA的传送方式：当I/O设备与CPU同时访问主存时，可能发生冲突，有以下几种策略：

   - 停止CPU访存
     当I/O设备有DMA请求时，由DMA接口向CPU发送一个停止信号，停止访问主存，直到DMA传送一块数据结束，DMA接口通知CPU可以使用主存，并把总线控制权交给CPU。

   - DMA与CPU​交替访存
     将CPU的工作周期分成两个时间片，一个分给CPU访存，另一个给DMA访存，这样在每个CPU周期内，CPU和DMA就都可以轮流访存。

   - 周期挪用

     I/O设备挪用一个存取周期，传送完一个数据字后立即释放总线。若此时CPU正在访存，必须待访存周期结束后，CPU再将总线占用权让出；若CPU和I/O同时访存，则CPU暂时放弃总线占用权。

5. DMA的传送过程

   - 预处理
     初始化DMA控制器中的有关寄存器、设置传送方式、测试并启动设备等。然后CPU继续执行原程序，直到I/O设备准备好发送的数据或接收的数据时，I/O设备向DMA控制器发送DMA请求，再由DMA控制器向CPU发出总线请求，用于传输数据。
   - 数据传送
     DMA以数据块为基本单位。
   - 后处理
     DMA控制器向CPU发送中断请求，CPU执行中断服务程序做DMA结束处理，包括校验数据等后处理工作。

6. DMA方式和中断方式的区别

   - 中断方式是程序的切换，需要保护和恢复现场，而DMA方式不中断现行程序，无须保护现场，除了预处理和后处理，其他时候不占用任何CPU资源
   - 对中断请求的响应只发生在每条指令的执行周期后，而对DMA请求的响应可发生在任何时期
   - 中断传送过程需要CPU的干预，而DMA传送过程不需要CPU的干预，因此速率非常高，适合于高速外设的成组数据传送
   - DMA请求的优先级高于中断请求
   - 中断方式具有处理异常事件的能力，而DMA方式仅局限于大批数据的传输
   - 中断方式靠程序传送，而DMA​方式靠硬件传送

### 错题

1. 可以提出中断的有(  )

   I. 外部事件

   II. Cache

   III. 虚拟存储器失效

   IV. 浮点数运算下溢

   V. 浮点数运算上溢

   A. I、III和IV

   B. I和V

   C. I、II和V

   D. I、III和V

2. 在中断响应周期中，由(  )将允许中断触发器置为0

   A. 关中断指令

   B. 中断隐指令

   C. 开中断指令

   D. 中断程序服务

3. 设置中断屏蔽标志可以改变(  )

   A. 多个中断源的中断请求优先级

   B. CPU对多个中断请求响应的优先次序

   C. 多个中断服务程序开始执行的顺序

   D. 多个中断程序执行完的次序

4. 单级中断系统中，中断服务程序内的执行顺序是(  )

   I. 保护现场

   II. 开中断

   III. 关中断

   IV. 保存断点

   V. 中断事件处理

   VI. 恢复现场

   VII. 中断返回

   A. I$ \rightarrow $V$ \rightarrow $VI$ \rightarrow $II$ \rightarrow $VII

   B. III$ \rightarrow $I$ \rightarrow $V $ \rightarrow $VII

   C. III$ \rightarrow $IV $ \rightarrow $V $ \rightarrow $VI $ \rightarrow $VII

   D. IV$ \rightarrow $I $ \rightarrow $V $ \rightarrow $VI $ \rightarrow $VII

5. 下列关于中断I/O方式和DMA方式比较的叙述中，错误的是(  )

   A. 中断I/O方式请求的是CPU处理时间，DMA方式请求的是总线使用权

   B. 中断响应发生在一条指令执行结束后，DMA响应发生在一个总线事务完成后

   C. 中断I/O方式下数据传送通过软件完成，DMA方式下数据传送由硬件完成

   D. 中断I/O方式适用于所有外部设备，DMA方式仅适用于快速外部设备

6. 下列关于外部I/O中断的叙述中，正确的是(  )

   A. 中断控制器按所接收中断请求的先后顺序进行中断优先级排队

   B. CPU响应中断时，通过执行中断隐指令完成通用寄存器的保护

   C. CPU只有在处于中断允许状态时，才能响应外部设备的中断请求

   D. 有中断请求时，CPU立即暂停当前指令执行，转去执行中断服务程序

7. 若设备采用周期挪用DMA方式进行输入输出，每次DMA输送的数据块大小为512B，相应的I/O接口中有一个32位数据缓冲寄存器。对于数据输入过程，叙述错误的是(  )

   A. 每准备好32位数据，DMA控制器就发出一次总线请求

   B. 相对于CPU，DMA控制器的总线使用权优先级更高

   C. 在整个数据块的传送过程中，CPU不可以访问主存

   D. 数据块传送结束时，会产生“DMA传送结束”中断请求

8. 下列是关于多重中断系统中CPU响应中断的叙述，错误的是(  )

   A. 仅在用户态下，CPU才能检测和响应中断

   B. CPU只有在检测到中断请求信号后，才会进入中断响应周期

   C. 进入中断响应周期时，CPU一定处于中断允许状态

   D. 若CPU检测到中断请求信号，则一定存在未被屏蔽的中断源请求信号

9. 设某计算机有4个中断源1、2、3、4，其硬件排队优先次序按1$ \rightarrow $2$ \rightarrow $3$ \rightarrow $4降序排列，各中断源的服务程序中所对应的屏蔽字如下表所示：

   | 中断源\屏蔽字 |  1   |  2   |  3   |  4   |
   | :-----------: | :--: | :--: | :--: | :--: |
   |       1       |  1   |  1   |  0   |  1   |
   |       2       |  0   |  1   |  0   |  0   |
   |       3       |  1   |  1   |  1   |  1   |
   |       4       |  0   |  1   |  0   |  1   |

   (1). 给出上述四个中断源的中断处理次序。
   (2). 若四个中断源同时有中断请求，画出CPU执行程序的轨迹。